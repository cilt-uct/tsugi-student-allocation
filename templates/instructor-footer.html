{% foreach($scripts as $script): %}
    <script src="{{$script}}" type="text/javascript"></script>
{% endforeach; %}

<script type="text/javascript">    
    $(document).ready(function(){
        var _settings = JSON.parse('{{ $allocationsettings }}');
        var _groups = JSON.parse('{{ $allocationgroups }}');
        var _choices = JSON.parse('{{ $studentchoices }}');
        var groupedChoices = {};

        if(_settings.length > 0 || _groups.length > 0 || _choices.length > 0) {
            var state = _settings[0].state;
            var selections = [];

            $('#tblGroupsList tbody').empty();
            populateSettings(_settings);
            _groups.forEach(function(group) {
                var avail_spaces = group.group_size;
                var num_students = 0;
                _choices.forEach(function(choice) {
                    if (choice.assigned === '1' && choice.group_id === group.group_id) {
                        avail_spaces--;
                        num_students++;
                    }
                });

                group.avail_spaces = avail_spaces;
                group.num_students = num_students;
            });

            $('#tblGroupsList tbody').html(tmpl('tmpl-options', _groups));

            if (state === "waiting") {
                $('#frmAddGroups, #tblGroupsList').find('input, select, textarea, button').prop('disabled', true);
                $('#btnCancel, #btnSave, #btnAddRow, #run_allocation').hide();
                $('#tblGroupsList .delete-row').hide();
            } else {
                $("#tblGroupsList tbody").sortable({
                items: 'tr',
                dropOnEmpty: false,
                start: function (G, ui) {
                    ui.item.addClass("select");
                },
                stop: function (G, ui) {
                    ui.item.removeClass("select");
                    updateGroupIds();
                }
            });
            }
            populateSelections(_choices);
        }
       
        $('#btnAddRow').click(function(event) {
            event.preventDefault();
            addRow({ id: '', group_name: '', size: '' });
        });

        $(document).on('click', '#tblGroupsList tbody .delete-row', function(event) {
            event.preventDefault();
            $(this).closest('tr').remove();
            updateGroupIds();
        });

        $('#frmAddGroups').submit(function(event) {
            event.preventDefault();
            var formData = new FormData(this);
            var emptyRows = false;

            $('#tblGroupsList tbody tr').each(function() {
                var groupId = $(this).find('input[name="group-title[]"]').val().trim();
                var groupSize = $(this).find('input[name="group-size[]"]').val().trim();
                
                if (groupId === '' || groupSize === '') {
                    emptyRows = true;
                    return false;
                }
            });

            if (emptyRows) {
                alert('Please fill in all fields for each group before submitting.');
                return false; 
            } 
            else {
                $.ajax({
                    url: '{{ $configure }}',
                    type: 'POST',
                    data: formData,
                    contentType: false,
                    processData: false,
                    success: function(response) {
                        location.reload();
                    },
                    error: function(xhr, status, error) {
                        console.error(JSON.parse(xhr.responseText).error);
                    }
                });
            }
           
        });

        $('#frmAddGroups #btnCancel').click(function(event) {
            event.preventDefault();
            $('#frmAddGroups')[0].reset();
            $('#tblGroupsList tbody').empty();
            populateSettings(_settings);
            populateGroups(_groups);
        });

        $('#run_allocation').click(function(event) {
            event.preventDefault();

            $.ajax({
                url: '{{ $updatestate }}',
                type: 'POST',
                data:JSON.stringify({ "tool-state": "waiting" }),
                contentType: 'application/json',
                success: function(response) {
                    location.reload();
                    $("#run_allocation").hide();
                    check_waiting_sites();
                },
                error: function(xhr, status, error) {
                    console.error(JSON.parse(xhr.responseText).error);
                }
            });
        })

        $('.btn-search').click(function() {
            var $searchForm = $(this).closest('form');
            var searchText = $searchForm.find('.search-input').val().trim().toLowerCase();
            if (searchText === '') {
                $searchForm.closest('.tab-pane').find('.table tbody tr').show();
            } else {
                $searchForm.closest('.tab-pane').find('.table tbody tr').hide().filter(function() {
                    var $tds = $(this).find('td:nth-child(-n+2)');
                    var found = false;
                    $tds.each(function() {
                        if ($(this).text().toLowerCase().indexOf(searchText) > -1) {
                            found = true;
                            return false;
                        }
                    });
                    return found;
                }).show();
            }
        });

        $('.clear-search').click(function(event) {
            event.preventDefault();
            var $searchForm = $(this).closest('form');
            $searchForm.find('.search-input').val('');
            $searchForm.closest('.tab-pane').find('.table tbody tr').show();
        });

        $('#btnDownloadMemberships').click(function(event) {
            event.preventDefault();
            var csvData = '';
            var headers = $('#tbl-user-memberships thead th');

            headers.each(function(index) {
                if (index > 0) {
                    csvData += ',';
                }
                csvData += $(this).text();
            });

            csvData += '\n';

            var rows = $('#tbl-user-memberships tbody tr');

            rows.each(function(rowIndex) {
                var cells = $(this).find('td');

                // Loop through each cell and append its text to CSV data
                cells.each(function(cellIndex) {
                    if (cellIndex > 0) {
                        csvData += ',';
                    }
                    csvData += $(this).text();
                });

                if (rowIndex < rows.length - 1) {
                    csvData += '\n';
                }
            });

            var blob = new Blob([csvData], { type: 'text/csv;charset=utf-8' });
            var link = document.createElement('a');

            link.href = window.URL.createObjectURL(blob);
            link.download = 'table_data.csv';

            document.body.appendChild(link);
            link.click();

            document.body.removeChild(link);
        });

        $('#assignModal').on('show.bs.modal', function(event) {
            var button = $(event.relatedTarget); 
            var studentId = button.data('id');
            var modal = $(this);
            var availableGroups = _groups.filter(function(group) {
                return group.avail_spaces > 0;
            });

            $('#studentId').val(studentId);
            $('#studentIdDisplay').text(studentId);
            $('#assignedGroup').empty();
            $('#assignedGroup').append($('<option>', {value: '', text: 'Select from list'}));

            availableGroups.forEach(function(group) {
                $('#assignedGroup').append($('<option>', {
                    value: group.group_id,
                    text: group.group_id + ': ' + group.group_name
                }));
            });
        });

        $('#frmAssign').submit(function(event) {
            event.preventDefault();
            var formData = new FormData(this);
            
            $.ajax({
                url: '{{ $assign }}',
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function(response) {
                    location.reload();
                },
                error: function(xhr, status, error) {
                    console.error(JSON.parse(xhr.responseText).error);
                }
            });
        })

        function populateSettings(allocation_settings) {
            if (allocation_settings.length > 0) {
                var settings = _settings[0];

                $('#tool-id').val(settings.link_id);
                $('#tool-name').val(settings.name);
                $('#instructions').val(settings.instructions);
                $('#release-date').val(settings.release_date.split(' ')[0]);
                $('#closing-date').val(settings.closing_date.split(' ')[0]);
                $('#groups-doc').val(settings.groups_doc);
                $('#min-selections').val(settings.min_selections);
                $('#max-selections').val(settings.max_selections);
            }
        }

        function updateGroupIds() {
            $('#tblGroupsList tbody tr').each(function(index) {
                var newGroupId = ("000" + (index + 1)).slice(-3);
                $(this).find('.group-id-cell span').text(newGroupId);
                $(this).find('.group-id-cell input').val(newGroupId);
            });
        }

        function addRow(group) {
            var projectId = $('#tblGroupsList tbody tr').length + 1;
            projectId = ("000" + projectId).slice(-3);

            $('#tblGroupsList tbody').append(tmpl('tmpl-option-row', 
                            {'group_id': projectId, 'group_name': '', 'group_size': 1}));

            updateGroupIds();
        }

        function validateForm() {
            var isValid = true;
            $('#tblGroupsList tbody tr').each(function() {
                var groupId = $(this).find('.group-id').val();
                var groupName = $(this).find('.group-title').val();
                var groupSize = $(this).find('.group-size').val();
                if (groupId === '' && groupName === '' && groupSize === '') {
                    $(this).remove();
                } else if (groupName === '' || groupSize === '') {
                    isValid = false;
                    alert('Please fill in all fields.');
                    return false;
                }
            });
            return isValid;
        }

        function populateSelections(user_choices) {
            user_choices.forEach(function(project) {
                var userId = project.user_id;
                var groupId = project.group_id;
                var groupName = project.group_name;
                var assigned = project.assigned;
                var choiceId = project.choice_id;
                var allocatedGroup = groupId + ": " + groupName;

                if (!groupedChoices[userId]) {
                    groupedChoices[userId] = { user_id: userId, user_name: project.user_name, grouped_choices: [],
                        allocated_to: assigned === "1" ? groupId : "Not assigned", allocated_group: assigned === "1" ? allocatedGroup : ""
                    };
                } else {
                    if (groupedChoices[userId].allocated_to === "" && assigned === "1") {
                        groupedChoices[userId].allocated_to = groupId;
                        groupedChoices[userId].allocated_group = allocatedGroup;
                    }
                }

                groupedChoices[userId].grouped_choices.push({ group_id: groupId, choice_id: choiceId });

                if (assigned === "1") {
                    groupedChoices[userId].allocated_to = groupId;
                    groupedChoices[userId].allocated_group = allocatedGroup;
                }
            });

            for (var userId in groupedChoices) {
                groupedChoices[userId].grouped_choices = groupedChoices[userId].grouped_choices
                    .sort((a, b) => a.choice_id - b.choice_id).map(choice => choice.group_id).join(', ');
            }

            var groupedChoicesArray = Object.values(groupedChoices);
            $('#tbl-allocation-choices tbody').html(tmpl('tmpl-selections', groupedChoicesArray));
            $('#tbl-user-memberships tbody').html(tmpl('tmpl-memberships', groupedChoicesArray));

            var isNotAllocated = groupedChoicesArray.some(function(choice) {
                return choice.allocated_to === "Not assigned";
            });

            if (!isNotAllocated) {
                $('#run_allocation, #divSelections').hide();
                $('#divMemberships').show();
            }
        }

        function setState(state) {

            $.ajax({
                url: '{{ $updatestate }}',
                type: 'POST',
                data: JSON.stringify({"tool-state": state}),
                contentType: 'json',
                success: function(response) {
                },
                error: function(xhr, status, error) {
                    console.error(JSON.parse(xhr.responseText).error);
                }
            });
        }
    
        function allocateUsers() {
            $.ajax({
                url: '{{ $allocate }}',
                type: 'GET',
                contentType: 'json',
                success: function(response) {
                    location.reload();
                },
                error: function(xhr, status, error) {
                    console.error(JSON.parse(xhr.responseText).error);
                }
            });
        }
    
    });

</script>
