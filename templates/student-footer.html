{% foreach($scripts as $script): %}
    <script src="{{$script}}" type="text/javascript"></script>
{% endforeach; %}

<script type="text/javascript">  
    var selectedChoices = [];
    var currentDate = new Date();
    var today = currentDate.getFullYear() + '-' + ('0' + (currentDate.getMonth() + 1)).slice(-2) + '-' + ('0' + currentDate.getDate()).slice(-2);

    $(document).ready(function(){
        var _settings = JSON.parse('{{$allocationdetails}}');
        var _options = JSON.parse('{{$allocationgroups}}');
        var _choices = JSON.parse('{{$selectedgroups}}');
   
        if(_settings.length > 0 || _options.length > 0 || _choices.length > 0) {
            var details = _settings[0];
	        var releaseDate = details.release_date.split(' ')[0];
            var closingDate = details.closing_date.split(' ')[0];
	        var assignedGroup = _choices.find(choice => choice.assigned === 1);
            var state = _settings[0].state;

	        $('#tool-title').html(details.name);
	   
	        // Check if the tool is released
            if (today < releaseDate) {
                window.location.href = 'coming-soon.php';
            } else {
                // Check if groups or projects are set
                if (_options.length > 0) {
                    $('#instructions').html(tmpl('tmpl-settings', details));
                    $('#tblGroups tbody').html(tmpl('tmpl-option-row', { details: details, choices: _choices, options: _options }));
                    
		            // Check if the student is already assigned to a group or project
                    if (assignedGroup) {
                        $('#assigned_div').html(tmpl('tmpl-assigned-to', assignedGroup));
                        $('#assigned_div').show();
                        $('#tblGroups select').attr("disabled", "disabled");
                        $('#btnSubmitChoices, #divInstructions').hide();
                    }

		            // Check if allocation is in progress and disable project selection
                    if (state === "waiting") {
                        $('#frmSubmitChoices').find('select, button').prop('disabled', true);
                        $('#btnSubmitChoices').hide();
                    }

                    // Check if allocation is complete
                    if (state === "assigned") {
                        $('#tblGroups select').attr('disabled', "disabled");
                        $('#btnSubmitChoices').hide();
                    }

                    $('#tool-details').show();
                } else {
                    window.location.href = 'coming-soon.php';
                }
            }

            // Check if expiry date reached or passed
            if(today > closingDate) {
                $('#frmSubmitChoices').find('select, button').prop('disabled', true);
                $('#btnSubmitChoices').hide();
            }
	    }else {
            window.location.href = 'coming-soon.php';
        }

        $('#frmSubmitChoices').submit(function(event) {
            event.preventDefault();
            var formData = new FormData(this);
            var selectedCount = $('.project-selection').filter(function() {
                return $(this).val() !== '';
            }).length;

            if (selectedCount < details.min_selections) {
                $('#error-message').html('<span class="glyphicon glyphicon-remove" aria-hidden="true"></span> Please select at least ' + details.min_selections + ' option(s) before submission.');
                return; 
            } else {
                $('#error-message').html(''); 
                $('#error-message').hide();
            }

            $.ajax({
                url: '{{ $addchoices }}',
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function(response) {
                    location.reload();
                },
                error: function(xhr, status, error) {
                    console.error(error);
                    $('#error-message').html('An error occurred while processing your submission. Please try again later.');
                    $('#error-message').show();
                }
            });
        });
    
        $('.project-selection').change(function() {
            updateChoices(this);
        })

    });

    function updateChoices(select) {
        var selectedChoice = select.value;
        var rowIndex = $(select).closest('tr').index();

        $(select).closest('tbody').find('.project-selection').each(function() {
            if (this !== select) {
                var choice = $(this).val();
                if (choice === selectedChoice) {
                    $(this).val('');
                }
            }
        });
    }

</script>
